{"version":3,"sources":["../../src/routes/webhooks.js"],"names":["router","express","Router","get","req","res","query","messengerconfig","WEBHOOK_TOKEN","send","post","sendStatus","data","body","object","entry","forEach","pageEntry","messaging","messagingEvent","console","log","message","receiveApi","handleReceiveMessage","postback","handleReceivePostback"],"mappings":";;;;;;AAQA;;;;AAGA;;;;AACA;;;;AAFA;AAKA,MAAMA,SAASC,kBAAQC,MAAR,EAAf;;AAEA;;;;;;;AAjBA;;;;;;;AAOA;AAiBAF,OAAOG,GAAP,CAAW,GAAX,EAAgB,CAACC,GAAD,EAAMC,GAAN,KAAc;AAC7B,MAAID,IAAIE,KAAJ,CAAU,kBAAV,MAAkCC,wBAAgBC,aAAtD,EAAqE;AACpEH,QAAII,IAAJ,CAASL,IAAIE,KAAJ,CAAU,eAAV,CAAT;AACA,GAFD,MAEO;AACND,QAAII,IAAJ,CAAS,oBAAT;AACA;AACD,CAND;;AAQA;;;;;;;;;AASAT,OAAOU,IAAP,CAAY,GAAZ,EAAiB,CAACN,GAAD,EAAMC,GAAN,KAAc;AAC7B;;;;;;;;;;AAYDA,MAAIM,UAAJ,CAAe,GAAf;;AAEA,QAAMC,OAAOR,IAAIS,IAAjB;;AAEA;AACA,MAAID,KAAKE,MAAL,KAAgB,MAApB,EAA4B;AAC3B;AACA;AACAF,SAAKG,KAAL,CAAWC,OAAX,CAAoBC,SAAD,IAAe;AACjC;AACAA,gBAAUC,SAAV,CAAoBF,OAApB,CAA6BG,cAAD,IAAoB;AAC/CC,gBAAQC,GAAR,CAAY,EAAEF,cAAF,EAAZ;AACA,YAAIA,eAAeG,OAAnB,EAA4B;AAC3BC,4BAAWC,oBAAX,CAAgCL,cAAhC;AACA,SAFD,MAEO,IAAIA,eAAeM,QAAnB,EAA6B;AACnCF,4BAAWG,qBAAX,CAAiCP,cAAjC;AACA,SAFM,MAED;AACLC,kBAAQC,GAAR,CACC,2CADD,EAECF,cAFD;AAIA;AACD,OAZD;AAaA,KAfD;AAgBA;AACD,CAtCD;;kBAwCenB,M","file":"webhooks.js","sourcesContent":["/**\r\n * Copyright 2017-present, Facebook, Inc. All rights reserved.\r\n *\r\n * This source code is licensed under the license found in the\r\n * LICENSE file in the root directory of this source tree.\r\n */\r\n\r\n// ===== MODULES ===============================================================\r\nimport express from 'express';\r\n\r\n// ===== MESSENGER =============================================================\r\nimport receiveApi from '../messenger-api-helpers/receive';\r\nimport {messengerconfig} from '../../config.json';\r\n\r\n\r\nconst router = express.Router();\r\n\r\n/**\r\n * This is used so that Facebook can verify that they have\r\n * the correct Webhook location for your app.\r\n *\r\n * The Webhook token must be set in your app's configuration page\r\n * as well as in your servers environment.\r\n */\r\nrouter.get('/', (req, res) => {\r\n\tif (req.query['hub.verify_token'] === messengerconfig.WEBHOOK_TOKEN) {\r\n\t\tres.send(req.query['hub.challenge']);\r\n\t} else {\r\n\t\tres.send('Error, wrong token');\r\n\t}\r\n});\r\n\r\n/**\r\n * Once your Webhook is verified this is where you will receive\r\n * all interactions from the users of you Messenger Application.\r\n *\r\n * You can subscribe to many different types of messages.\r\n * However for this demo we've only handled what is necessary:\r\n * 1. Regular messages\r\n * 2. Postbacks\r\n */\r\nrouter.post('/', (req, res) => {\r\n  /*\r\n    You must send back a status of 200(success) within 20 seconds\r\n    to let us know you've successfully received the callback.\r\n    Otherwise, the request will time out.\r\n\r\n    When a request times out from Facebook the service attempts\r\n    to resend the message.\r\n\r\n    This is why it is good to send a response immediately so you\r\n    don't get duplicate messages in the event that a request takes\r\n    awhile to process.\r\n  */\r\n\tres.sendStatus(200);\r\n\r\n\tconst data = req.body;\r\n\r\n\t// Make sure this is a page subscription\r\n\tif (data.object === 'page') {\r\n\t\t// Iterate over each entry\r\n\t\t// There may be multiple if batched\r\n\t\tdata.entry.forEach((pageEntry) => {\r\n\t\t\t// Iterate over each messaging event and handle accordingly\r\n\t\t\tpageEntry.messaging.forEach((messagingEvent) => {\r\n\t\t\t\tconsole.log({ messagingEvent });\r\n\t\t\t\tif (messagingEvent.message) {\r\n\t\t\t\t\treceiveApi.handleReceiveMessage(messagingEvent);\r\n\t\t\t\t} else if (messagingEvent.postback) {\r\n\t\t\t\t\treceiveApi.handleReceivePostback(messagingEvent);\r\n\t\t\t\t}else {\r\n\t\t\t\t\tconsole.log(\r\n\t\t\t\t\t\t'Webhook received unknown messagingEvent: ',\r\n\t\t\t\t\t\tmessagingEvent\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n});\r\n\r\nexport default router;\r\n"]}