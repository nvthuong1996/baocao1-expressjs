{"version":3,"sources":["../../src/routes/signupAPI.js"],"names":["router","express","Router","get","req","res","next","nickname","fbid","token","query","trim","_tt","replace","length","status","json","err","auth_jwt","decode","then","decoded","id","ten_sv","date","Date","getTime","console","log","model","user","findOne","where","mssv","result","Promise","reject","nick_name","create","is_active","account","addAccountToGroupConversion","token_login","encode","type","send","catch","ex","mdks","dkmh","findAll","item","monhoc","mdk","conversion","user_conversion","user_id","conversion_id","access","JSON","stringify","name","avatar","update","module","exports"],"mappings":"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","file":"signupAPI.js","sourcesContent":["import express from \"express\";\r\nimport model from \"../model\";\r\nimport {auth_jwt} from \"../auth\";\r\n\r\nvar router = express.Router();\r\n\r\n/*\r\n\tBước 1:\r\n*/\r\nrouter.get('/', function(req, res, next) {\r\n\tlet {nickname,fbid,token} = req.query;\r\n\t\r\n\r\n\tnickname = nickname.trim();\r\n\tlet _tt = nickname.replace(/ /g,'');\r\n\tif(_tt.length<4||nickname.length>25){\r\n\t\treturn res.status(200).json({\r\n\t\t\terr:\"Nick name không hợp lệ. Nick name nên có từ 4 kí tự và bắt đầu bằng chữ\",\r\n\t\t})\r\n\t}\r\n\r\n\tauth_jwt.decode(token)\r\n\t.then((decoded)=>{\r\n\t\tlet {id,ten_sv,date} = decoded;\r\n\t\t\r\n\t\tif(new Date().getTime() - date > 15*60*1000){\r\n\t\t\treturn res.status(200).json({\r\n\t\t\t\terr:\"Token đã hết hạn. Vui lòng login lại\",\r\n\t\t\t});\r\n\t\t}\r\n\t\t// Check nickname,fb_id\r\n\t\tconsole.log(\"1\");\r\n\t\treturn model.user.findOne({\r\n\t\t\twhere:{\r\n\t\t\t\tmssv:id\r\n\t\t\t}\r\n\t\t})\r\n\t\t.then((result)=>{\r\n\t\t\tif(result){\r\n\t\t\t\treturn Promise.reject(\"Tài khoản đã được tạo\");\r\n\t\t\t}else{\r\n\t\t\t\treturn model.user.findOne({\r\n\t\t\t\t\twhere:{\r\n\t\t\t\t\t\tnick_name:nickname\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t\t.then((result)=>{\r\n\t\t\t\t\tif(result){\r\n\t\t\t\t\t\treturn Promise.reject(\"Nick name của bạn bị trùng\");\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\treturn model.user.create({\r\n\t\t\t\t\t\t\tmssv:id,\r\n\t\t\t\t\t\t\tis_active:1,\r\n\t\t\t\t\t\t\tnick_name:nickname,\r\n\t\t\t\t\t\t}).then((account)=>{\r\n\t\t\t\t\t\t\t// Thêm user vào conversion nhóm\r\n\r\n\t\t\t\t\t\t\taddAccountToGroupConversion(account.mssv);\r\n\r\n\t\t\t\t\t\t\tvar token_login = auth_jwt.encode({\r\n\t\t\t\t\t\t\t\tid: id,\r\n\t\t\t\t\t\t\t\tten_sv:ten_sv,\r\n\t\t\t\t\t\t\t\ttype:\"login\",\r\n\t\t\t\t\t\t\t\tdate:new Date().getTime() \r\n\t\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\t\treturn res.status(200).send({\r\n\t\t\t\t\t\t\t\terr:null,\r\n\t\t\t\t\t\t\t\ttoken:token_login\r\n\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t})\r\n\t})\r\n\t.catch((ex)=>{\r\n\t\treturn res.status(200).json({\r\n\t\t\terr:ex+\"\",\r\n\t\t})\r\n\t})\r\n});\r\n\r\n\r\n\r\nasync function addAccountToGroupConversion(mssv){\r\n\tlet mdks = await model.dkmh.findAll({\r\n\t\twhere:{\r\n\t\t\tmssv:mssv\r\n\t\t}\r\n\t});\r\n\r\n\tfor(let item of mdks){\r\n\t\tlet monhoc = await model.monhoc.findOne({\r\n\t\t\twhere:{\r\n\t\t\t\tmdk:item.mdk,\r\n\t\t\t}\r\n\t\t})\r\n\r\n\t\tlet conversion =await model.user_conversion.findOne({\r\n\t\t\twhere:{\r\n\t\t\t\tuser_id:mssv,\r\n\t\t\t\tconversion_id:monhoc.conversion_id\r\n\t\t\t}\r\n\t\t})\r\n\r\n\t\tif(!conversion){\r\n\t\t\tawait model.user_conversion.create({\r\n\t\t\t\tuser_id:mssv,\r\n\t\t\t\tconversion_id:monhoc.conversion_id,\r\n\t\t\t\tis_active:1,\r\n\t\t\t\taccess:JSON.stringify({name:true,avatar:true})\r\n\t\t\t})\r\n\t\t}else{\r\n\t\t\tconversion.update({\r\n\t\t\t\tuser_id:mssv,\r\n\t\t\t\tconversion_id:monhoc.conversion_id,\r\n\t\t\t\tis_active:1,\r\n\t\t\t\taccess:JSON.stringify({name:true,avatar:true})\r\n\t\t\t})\r\n\t\t}\r\n\t}\r\n\r\n\t\r\n}\r\n\r\nmodule.exports = router;\r\n"]}