{"version":3,"sources":["../../src/routes/conversion.js"],"names":["router","express","Router","use","req","res","next","isUnauthenticated","redirect","get","user","mssv","conversion","conversionController","loadConversionType1","render","conversions","type","loadConversionType2","model","user_conversion","findOne","where","user_id","conversion_id","params","id","messages","getMessage","post","nguoinhan","body","toUpperCase","nguoigui","messageSend","Error","conversion_nguoigui","findAll","conversion_nguoinhan","conversion_id_all","checkConversion","getConversion","m","content","createMessage","message","create","creator_id","message_body","JSON","stringify","status","json","err","id_conversion","ex","reduce","start","item","then","result","Promise","resolve","name","is_active","createConversion","access","con_a","con_b","i","j","concat","length","_messages","order","limit","reverse","update","is_reader","name_conversion","friend_conversion","filter","you_conversion","friend_info","getFullInfoUser","you_info","usermap","access_friend","parse","access_you","qldt_account","ten_sv","nick_name","obj","_tmp","time_createAt","createdAt","toLocaleString","time","avatar","creator","result1","fb_account","result2","plain","module","exports"],"mappings":"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","file":"conversion.js","sourcesContent":["import express from \"express\";\r\nimport {auth_passport} from \"../auth\";\r\nimport model from \"../model\";\r\nimport { start } from \"repl\";\r\nimport { isBuffer } from \"util\";\r\nimport {conversionController} from \"../controller\";\r\nimport {sendMessageToRoom} from \"../sockets\";\r\n\r\n\r\nconst router = express.Router();\r\n\r\n/* GET home page. */\r\n\r\n\r\nrouter.use((req,res,next)=>{\r\n\tif(req.isUnauthenticated()){\r\n\t\treturn res.redirect('/login');\r\n\t}\r\n\treturn next();\r\n})\r\n\r\n\r\nrouter.get(\"/\",async (req,res,next)=>{\r\n\tconst user = req.user.mssv;\r\n\tconst conversion = await conversionController.loadConversionType1(user);\r\n\treturn res.render('conversion',{\r\n\t\tconversions:conversion,\r\n\t\ttype:1\r\n\t});\r\n\r\n})\r\n\r\nrouter.get(\"/group\",async (req,res,next)=>{\r\n\tconst user = req.user.mssv;\r\n\tconst conversion = await conversionController.loadConversionType2(user);\r\n\treturn res.render('conversion',{\r\n\t\tconversions:conversion,\r\n\t\ttype:2\r\n\t});\r\n})\r\n\r\nrouter.get(\"/new\",(req,res,next)=>{\r\n    res.render('newconversion');\r\n    \r\n})\r\n\r\nrouter.get(\"/:id\",async (req,res,next)=>{\r\n\t\r\n\tconst user = req.user.mssv;\r\n\tconst conversion = await model.user_conversion.findOne({\r\n\t\twhere:{\r\n\t\t\tuser_id:user,\r\n\t\t\tconversion_id:req.params.id\r\n\t\t}\r\n\t})\r\n\r\n\tif(!conversion){\r\n\t\treturn next();\r\n\t}\r\n\r\n\t/*\r\n\t*\tTruy vấn cơ sở dữ liệu và render chatroom\r\n\t*\r\n\t*\r\n\t*\r\n\t*/\r\n\r\n\tconst messages = await getMessage(req.params.id,user);\r\n\r\n\tres.render('chatroom',messages);\r\n\r\n\r\n\r\n})\r\n\r\n\r\nrouter.post(\"/send\",async (req,res,next)=>{\r\n\tconst nguoinhan = req.body.mssv.toUpperCase();\r\n\tconst nguoigui = req.user.mssv;\r\n\tconst messageSend = req.body.body;\r\n\r\n\t\r\n\r\n\ttry{\r\n\t\tif(nguoigui==nguoinhan)\r\n\t\tthrow new Error(`Bạn không thể gửi tin nhắn cho chính mình`);\r\n\r\n\r\n\t\tconst user = await model.user.findOne({\r\n\t\t\twhere:{\r\n\t\t\t\tmssv:nguoinhan\r\n\t\t\t}\r\n\t\t})\r\n\t\tif(!user){\r\n\t\t\tthrow new Error(`${nguoinhan} chưa tham gia hệ thống`);\r\n\t\t}\r\n\r\n\t\tconst conversion_nguoigui = await model.user_conversion.findAll({\r\n\t\t\twhere:{\r\n\t\t\t\tuser_id:nguoigui\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tconst conversion_nguoinhan =await model.user_conversion.findAll({\r\n\t\t\twhere:{\r\n\t\t\t\tuser_id:nguoinhan\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tconst conversion_id_all = checkConversion(conversion_nguoigui,conversion_nguoinhan);\r\n\r\n\t\tconst conversion_id = await getConversion(conversion_id_all,nguoinhan,nguoigui);\r\n\r\n\t\t// ghi du lieu len message\r\n\r\n\t\tconst m = {\r\n\t\t\ttype:\"text\",\r\n\t\t\tcontent:messageSend\r\n\t\t}\r\n\r\n\t\tconst createMessage = await model.message.create({\r\n\t\t\tcreator_id:nguoigui,\r\n\t\t\tmessage_body:JSON.stringify(m),\r\n\t\t\tconversion_id:conversion_id\r\n\t\t})\r\n\r\n\r\n\t\tsendMessageToRoom(nguoigui,conversion_id,m);\r\n\r\n\t\treturn res.status(200).json({\r\n\t\t\terr:null,\r\n\t\t\tid_conversion:conversion_id\r\n\t\t})\r\n\r\n\t}\r\n\tcatch(ex){\r\n\t\treturn res.status(200).json({\r\n\t\t\terr:''+ex\r\n\t\t})\r\n\t}\r\n})\r\n\r\n\r\nfunction getConversion(conversion_id,nguoinhan,nguoigui){\r\n\t/*\r\n\t*\tNhan vao conversion id va return thong tin ve conversion do\r\n\t*\tNeu conversion khong co thi tao ra conversion\r\n\t*/\r\n\r\n\tif(conversion_id){\r\n\t\t//get conversion info\r\n\r\n\t\treturn conversion_id.reduce((start,item)=>{\r\n\t\t\treturn start.then((result)=>{\r\n\t\t\t\tif(result)\r\n\t\t\t\t\treturn Promise.resolve(result);\r\n\r\n\t\t\t\treturn model.conversion.findOne({\r\n\t\t\t\t\twhere:{\r\n\t\t\t\t\t\tid:item,\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t\t.then((result)=>{\r\n\t\t\t\t\tif(result.type==1){\r\n\t\t\t\t\t\treturn Promise.resolve(result);\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\treturn Promise.resolve(null);\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t})\r\n\t\t},Promise.resolve(null))\r\n\t\t.then((result)=>{\r\n\t\t\treturn Promise.resolve(result.id)\r\n\t\t});\r\n\r\n\t}else{\r\n\t\t//them moi conversion giua 2 nguoi\r\n\t\treturn model.conversion.create({\r\n\t\t\tname:null,\r\n\t\t\tis_active:1,\r\n\t\t\ttype:1\r\n\t\t})\r\n\t\t.then((createConversion)=>{\r\n\t\t\treturn model.user_conversion.create({\r\n\t\t\t\tconversion_id:createConversion.get(\"id\"),\r\n\t\t\t\tuser_id:nguoigui,\r\n\t\t\t\tis_active:1,\r\n\t\t\t\taccess:'{\"name\":true}'\r\n\t\t\t})\r\n\t\t})\r\n\t\t.then((result)=>{\r\n\t\t\treturn \tmodel.user_conversion.create({\r\n\t\t\t\tconversion_id:result.get(\"conversion_id\"),\r\n\t\t\t\tuser_id:nguoinhan,\r\n\t\t\t\tis_active:1,\r\n\t\t\t\taccess:\"{}\"\r\n\t\t\t})\r\n\t\t})\r\n\t\t.then((result)=>{\r\n\t\t\treturn Promise.resolve(result.get(\"conversion_id\"));\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction checkConversion(con_a,con_b){\r\n\r\n\tlet result = [];\r\n\tif(!con_a||!con_b)\r\n\t\treturn null;\r\n\tfor(let i of con_a){\r\n\t\tfor(let j of con_b){\r\n\t\t\tif(i.conversion_id==j.conversion_id){\r\n\t\t\t\tresult = result.concat(i.conversion_id);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tif(result.length!=0){\r\n\t\treturn result;\r\n\t}\r\n\treturn null;\r\n}\r\n\r\n\r\nasync function getMessage (conversion_id,user){\r\n\r\n\tconst conversion = await model.conversion.findOne({\r\n\t\twhere:{\r\n\t\t\tid:conversion_id\r\n\t\t}\r\n\t});\r\n\r\n\r\n\tconst _messages = await model.message.findAll({\r\n\t\twhere:{\r\n\t\t\tconversion_id:conversion_id,\r\n\t\t},\r\n\t\torder: [['updatedAt', 'DESC']],\r\n\t\tlimit:10\r\n\t});\r\n\r\n\tconst messages = _messages.reverse();\r\n\r\n\tif(messages.length!=0){\r\n\t\tmessages[messages.length-1].update({\r\n\t\t\tis_reader:1\r\n\t\t});\r\n\t}\r\n\r\n \r\n\r\n\tlet result = [];\r\n\tlet name_conversion = conversion.name;\r\n\r\n\tif(conversion.type==1){\r\n\t\t// xu ly kieu chat 1-1 ẩn danh\r\n\t\tconst user_conversion = await model.user_conversion.findAll({\r\n\t\t\twhere:{\r\n\t\t\t\tconversion_id:conversion_id\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tconst friend_conversion = user_conversion.filter((item)=>item.user_id!=user)[0];\r\n\t\tconst you_conversion = user_conversion.filter((item)=>item.user_id==user)[0];\r\n\t\t\r\n\t\tconst friend_info = await getFullInfoUser(friend_conversion.user_id);\r\n\t\tconst you_info = await getFullInfoUser(you_conversion.user_id);\r\n\t\r\n\t\r\n\t\tconst usermap = {};\r\n\t\tusermap[user] = you_info;\r\n\t\tusermap[friend_conversion.user_id] = friend_info;\r\n\r\n\t\tconst access_friend = JSON.parse(friend_conversion.access);\r\n\t\tconst access_you = JSON.parse(you_conversion.access);\r\n\r\n\t\tif(access_you.name){\r\n\t\t\tname_conversion = friend_info.qldt_account.ten_sv;\r\n\t\t}else{\r\n\t\t\tname_conversion = friend_info.user.nick_name;\r\n\t\t}\r\n\r\n\r\n\t\t// Dua vao access get thong tin nguoi dung\r\n\t\t\r\n\t\t\r\n\t\tfor(let message of messages){\r\n\t\t\tconst obj = usermap[message.creator_id];\r\n\r\n\t\t\tconst _tmp = JSON.parse(message.message_body);\r\n\r\n\t\t\tconst time_createAt = message.createdAt.toLocaleString(\"vi-VN\");\r\n\r\n\r\n\t\t\tif(obj.user.mssv==you_conversion.user_id){\r\n\t\t\t\t// tin nhan you gui\r\n\t\t\t\t/*\r\n\t\t\t\t*\tKiem tra xem nguoi kia co duoc xem ten ban hay khong\r\n\t\t\t\t*\r\n\t\t\t\t*\r\n\t\t\t\t*/\r\n\r\n\t\t\t\tif(access_friend.name){\r\n\t\t\t\t\tresult = result.concat({\r\n\t\t\t\t\t\tname:obj.qldt_account.ten_sv,\r\n\t\t\t\t\t\tcontent:_tmp.content,\r\n\t\t\t\t\t\ttype:_tmp.type,\r\n\t\t\t\t\t\ttime:time_createAt,\r\n\t\t\t\t\t\tavatar:\"\",\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t})\r\n\t\t\t\t}else{\r\n\t\t\t\t\tresult = result.concat({\r\n\t\t\t\t\t\tname:obj.user.nick_name,\r\n\t\t\t\t\t\tcontent:_tmp.content,\r\n\t\t\t\t\t\ttype:_tmp.type,\r\n\t\t\t\t\t\ttime:time_createAt,\r\n\t\t\t\t\t\tavatar:\"\"\r\n\t\t\t\t\t})\r\n\t\t\t\t}\r\n\t\t\t}else{\r\n\t\t\t\t// tin nhan friend gui\r\n\t\t\t\tif(access_you.name){\r\n\t\t\t\t\tresult = result.concat({\r\n\t\t\t\t\t\tname:obj.qldt_account.ten_sv,\r\n\t\t\t\t\t\tcontent:_tmp.content,\r\n\t\t\t\t\t\ttype:_tmp.type,\r\n\t\t\t\t\t\ttime:time_createAt,\r\n\t\t\t\t\t\tavatar:\"\"\r\n\t\t\t\t\t})\r\n\t\t\t\t}else{\r\n\t\t\t\t\tresult = result.concat({\r\n\t\t\t\t\t\tname:obj.user.nick_name,\r\n\t\t\t\t\t\tcontent:_tmp.content,\r\n\t\t\t\t\t\ttype:_tmp.type,\r\n\t\t\t\t\t\ttime:time_createAt,\r\n\t\t\t\t\t\tavatar:\"\"\r\n\t\t\t\t\t})\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t}\r\n\r\n\t}else if(conversion.type==2){\r\n\t\t// xu ly kieu chat group\r\n\t\tfor(const item of messages){\r\n\t\t\t// Xem nguoi tao ra no la ai\r\n\t\t\tlet creator = await getFullInfoUser(item.creator_id);\r\n\t\t\tconst _tmp = JSON.parse(item.message_body);\r\n\t\t\tconst time_createAt = item.createdAt.toLocaleString(\"vi-VN\");\r\n\r\n\t\t\tresult = result.concat({\r\n\t\t\t\tname:creator.qldt_account.ten_sv,\r\n\t\t\t\tcontent:_tmp.content,\r\n\t\t\t\ttype:_tmp.type,\r\n\t\t\t\ttime:time_createAt,\r\n\t\t\t\tavatar:\"\",\r\n\t\t\t})\r\n\t\t}\r\n\t}\r\n\r\n\treturn {\r\n\t\ttype:conversion.type,\r\n\t\tname:name_conversion,\r\n\t\tmessages:result,\r\n\t\tconversion_id:conversion_id,\r\n\t\tuser:user\r\n\t};\r\n}\r\n\r\n\r\nfunction getFullInfoUser(id){\r\n\treturn model.user.findOne({\r\n\t\twhere:{\r\n\t\t\tmssv:id\r\n\t\t}\r\n\t})\r\n\t.then((result1)=>{\r\n\t\treturn model.fb_account.findOne({\r\n\t\t\twhere:{\r\n\t\t\t\tid:result1.get(\"fb_id\")\r\n\t\t\t}\r\n\t\t}).then((result2)=>{\r\n\t\t\tif(result2){\r\n\t\t\t\treturn Promise.resolve({\r\n\t\t\t\t\tuser:result1.get({plain:true}),\r\n\t\t\t\t\tfb_account:result2.get({plain:true})\r\n\t\t\t\t})\r\n\t\t\t}else{\r\n\t\t\t\treturn Promise.resolve({\r\n\t\t\t\t\tuser:result1.get({plain:true}),\r\n\t\t\t\t\tfb_account:null\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t});\r\n\t})\r\n\t.then((result)=>{\r\n\t\treturn model.qldt_account.findOne({\r\n\t\t\twhere:{\r\n\t\t\t\tid:result.user.mssv\r\n\t\t\t}\r\n\t\t}).then((result1)=>{\r\n\t\t\tif(result1){\r\n\t\t\t\tresult[\"qldt_account\"] = result1.get({plain:true});\r\n\t\t\t\treturn Promise.resolve(result);\r\n\t\t\t}else{\r\n\t\t\t\tresult[\"qldt_account\"] = null;\r\n\t\t\t\treturn Promise.resolve(result);\r\n\t\t\t}\r\n\t\t});\r\n\t})\r\n}\r\n\r\n\r\nmodule.exports = router;\r\n"]}