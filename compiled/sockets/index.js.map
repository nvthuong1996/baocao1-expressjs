{"version":3,"sources":["../../src/sockets/index.js"],"names":["Op","Sequelize","ioSocket","attachSockets","io","on","socket","user","handshake","session","passport","disconnect","allConversion","model","user_conversion","findAll","where","user_id","forEach","element","join","conversion_id","message","check","findOne","insertMessage","type","content","createConversion","create","creator_id","message_body","JSON","stringify","typeConversion","conversion","id","access","_tmp","ne","parse","name","avatar","ten_sv","qldt_account","_user","mssv","nick_name","obj","body","time","Date","toLocaleString","to","emit","ex","sendMessageToRoom","then","result","Promise","resolve","catch","console","log"],"mappings":"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","file":"index.js","sourcesContent":["import model from \"../model\";\r\nimport Sequelize from \"sequelize\";\r\nconst Op = Sequelize.Op;\r\nlet ioSocket;\r\n\r\nvar attachSockets = (io) => {\r\n\tioSocket = io;\r\n\tio.on(\"connection\",async (socket)=>{\r\n\r\n\t\tconst user = socket.handshake.session.passport ? socket.handshake.session.passport.user:null;\r\n\r\n\t\tif(!user){\r\n\t\t\treturn socket.disconnect();\r\n\t\t}\r\n\r\n\t\t//Nếu có conversion_id thì join group chat\r\n\r\n\t\tconst allConversion =await model.user_conversion.findAll({\r\n\t\t\twhere:{\r\n\t\t\t\tuser_id:user\r\n\t\t\t}\r\n\t\t})\r\n\r\n\t\tif(allConversion){\r\n\t\t\tallConversion.forEach(element => {\r\n\t\t\t\tsocket.join(element.conversion_id);\r\n\t\t\t});\r\n\t\t}else{\r\n\t\t\treturn socket.disconnect();\r\n\t\t}\r\n\r\n\t\tsocket.on(\"user-send-message\",async (message)=>{\r\n\t\t\t// Kiem tra conversion_id co hop le khong\r\n\t\t\tconst conversion_id = message.conversion_id;\r\n\t\t\ttry{\r\n\t\t\t\tconst check = await model.user_conversion.findOne({\r\n\t\t\t\t\twhere:{\r\n\t\t\t\t\t\tuser_id:user,\r\n\t\t\t\t\t\tconversion_id:conversion_id\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif(!check) return ;\r\n\r\n\t\t\t\tconst insertMessage = {\r\n\t\t\t\t\ttype:message.type,\r\n\t\t\t\t\tcontent:message.content\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst createConversion = await model.message.create({\r\n\t\t\t\t\tcreator_id:user,\r\n\t\t\t\t\tmessage_body:JSON.stringify(insertMessage),\r\n\t\t\t\t\tconversion_id:conversion_id\r\n\t\t\t\t});\r\n\r\n\t\t\t\tconst typeConversion =await model.conversion.findOne({\r\n\t\t\t\t\twhere:{\r\n\t\t\t\t\t\tid:conversion_id\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\r\n\t\t\t\tlet access;\r\n\t\t\t\tif(typeConversion.type==1){\r\n\t\t\t\t\tlet _tmp  = await model.user_conversion.findOne({\r\n\t\t\t\t\t\twhere:{\r\n\t\t\t\t\t\t\tconversion_id:conversion_id,\r\n\t\t\t\t\t\t\tuser_id:{\r\n\t\t\t\t\t\t\t\t[Op.ne]: user\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\taccess = JSON.parse(_tmp.access);\r\n\r\n\r\n\t\t\t\t}else if(typeConversion.type==2){\r\n\t\t\t\t\taccess= {\r\n\t\t\t\t\t\tname:true,\r\n\t\t\t\t\t\tavatar:true\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tlet ten_sv,avatar=\"\";\r\n\t\t\t\tif(access.name){\r\n\t\t\t\t\tconst qldt_account = await model.qldt_account.findOne({\r\n\t\t\t\t\t\twhere:{\r\n\t\t\t\t\t\t\tid:user\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\tten_sv= qldt_account.ten_sv;\r\n\t\t\t\t}else{\r\n\t\t\t\t\tlet _user = await model.user.findOne({\r\n\t\t\t\t\t\twhere:{\r\n\t\t\t\t\t\t\tmssv:user\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\tten_sv = _user.nick_name;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst obj = {\r\n\t\t\t\t\tavatar:\"\",\r\n\t\t\t\t\tname:ten_sv,\r\n\t\t\t\t\tbody:insertMessage,\r\n\t\t\t\t\ttime:new Date().toLocaleString(\"vi-VN\"),\r\n\t\t\t\t\tconversion_id:conversion_id,\r\n\t\t\t\t\ttype:typeConversion.type,\r\n\t\t\t\t\tuser:user\r\n\t\t\t\t}\r\n\r\n\t\t\t\tio.to(conversion_id).emit(\"server-send-message\", obj);\r\n\r\n\r\n\t\t\t}catch(ex){\r\n\t\t\t\tsocket.to(conversion_id).emit(\"err\",ex+\"\");\r\n\t\t\t}\r\n\t\t})\r\n\t})\r\n}\r\n\r\n\r\nfunction sendMessageToRoom(user,conversion_id,message){\r\n\r\n\tmodel.conversion.findOne({\r\n\t\twhere:{\r\n\t\t\tid:conversion_id\r\n\t\t}\r\n\t})\r\n\t.then((result)=>{\r\n\t\tif(result.type==1){\r\n\t\t\t// xu ly kieu chat 1-1\r\n\t\t\treturn model.user_conversion.findOne({\r\n\t\t\t\twhere:{\r\n\t\t\t\t\tconversion_id:conversion_id,\r\n\t\t\t\t\tuser_id:{\r\n\t\t\t\t\t\t[Op.ne]: user\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t}else if(result.type==2){\r\n\t\t\t// xu ly kieu chat 2-2\r\n\r\n\r\n\r\n\t\t}\r\n\t})\r\n\t.then((result)=>{\r\n\t\tconst access = JSON.parse(result.access);\r\n\r\n\t\tif(access.name){\r\n\t\t\treturn model.qldt_account.findOne({\r\n\t\t\t\tid:user\r\n\t\t\t})\r\n\t\t\t.then((result)=>{\r\n\t\t\t\treturn Promise.resolve(result.ten_sv);\r\n\t\t\t})\r\n\t\t}else{\r\n\t\t\treturn model.user.findOne({\r\n\t\t\t\twhere:{\r\n\t\t\t\t\tmssv:user\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t\t.then((result)=>{\r\n\t\t\t\treturn Promise.resolve(result.nick_name);\r\n\t\t\t})\r\n\t\t}\r\n\t})\r\n\t.then((name)=>{\r\n\r\n\t\tconst obj = {\r\n\t\t\tavatar:\"\",\r\n\t\t\tname:name,\r\n\t\t\tbody:message,\r\n\t\t\ttime:new Date().toLocaleString(\"vi-VN\")\r\n\t\t}\r\n\t\t//socket.emit(\"server-send-message\", obj);\r\n\t\tioSocket.to(conversion_id).emit(\"server-send-message\", obj);\r\n\r\n\t})\r\n\r\n\t.catch((ex)=>{\r\n\t\tconsole.log(\"Có lỗi khi send message to room\");\r\n\t})\r\n\r\n}\r\n\r\n\r\n\r\n\r\nexport {attachSockets,sendMessageToRoom};\r\n"]}